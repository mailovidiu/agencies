rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Departments collection - Public read, admin write
    match /departments/{departmentId} {
      // Allow all users to read department information
      allow read: if true;
      
      // Only authenticated admin users can create, update, and delete departments
      allow create, update, delete: if request.auth != null 
        && request.auth.token.email in [
          "ovi@ovi.ro"  // Add your admin emails here
        ];
    }
    
    // User profiles collection - Private to user
    match /users/{userId} {
      // Users can only access their own profile
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // User favorites collection - Private to user
    match /users/{userId}/favorites/{favoriteId} {
      // Users can only access their own favorites
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // User analytics and interactions - Private to user
    match /users/{userId}/interactions/{interactionId} {
      // Users can only access their own interactions
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Department analytics (read-only for users, write for admin)
    match /analytics/departments/{departmentId} {
      // Allow read access to all authenticated users
      allow read: if request.auth != null;
      
      // Only admins can write analytics data
      allow write: if request.auth != null 
        && request.auth.token.email in [
          "ovi@ovi.ro"  // Add your admin emails here
        ];
    }
    
    // Global app settings - Admin only
    match /settings/{settingId} {
      // Allow read access to all authenticated users
      allow read: if request.auth != null;
      
      // Only admins can modify settings
      allow write: if request.auth != null 
        && request.auth.token.email in [
          "ovi@ovi.ro"  // Add your admin emails here
        ];
    }
    
    // AI chat history - Private to user
    match /users/{userId}/chatHistory/{chatId} {
      // Users can only access their own chat history
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Deny access to any other collections not explicitly defined
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

// Helper function to validate department data structure
function validateDepartmentData(data) {
  return data != null &&
         data.keys().hasAll(['name', 'shortName', 'description', 'category', 'contactInfo', 'services', 'keywords', 'isActive', 'isPopular']) &&
         data.name is string && data.name.size() > 0 &&
         data.shortName is string && data.shortName.size() > 0 &&
         data.description is string &&
         data.category is string &&
         data.isActive is bool &&
         data.isPopular is bool &&
         data.services is list &&
         data.keywords is list &&
         validateContactInfo(data.contactInfo) &&
         validateDepartmentCategory(data.category);
}

// Helper function to validate contact information
function validateContactInfo(contactInfo) {
  return contactInfo != null &&
         contactInfo is map &&
         contactInfo.keys().hasAll(['phone', 'email', 'website', 'address']) &&
         contactInfo.phone is string &&
         contactInfo.email is string &&
         contactInfo.website is string &&
         contactInfo.address is string;
}

// Helper function to validate department category
function validateDepartmentCategory(category) {
  return category in ['health', 'education', 'transportation', 'finance', 'security', 
                     'environment', 'agriculture', 'socialServices', 'defense', 'justice', 
                     'commerce', 'labor', 'energy', 'housing', 'veterans', 'other'];
}